name: Release CLI

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release CLI
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for version info
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Build binaries
        run: make build-cli-all
      
      - name: Create release directory
        run: |
          mkdir -p release/${{ steps.version.outputs.VERSION }}
          cp bin/poketactix-cli-* release/${{ steps.version.outputs.VERSION }}/
          cp CLI_README.md release/${{ steps.version.outputs.VERSION }}/README.md
          cp LICENSE release/${{ steps.version.outputs.VERSION }}/ || true
          cp scripts/install.sh release/${{ steps.version.outputs.VERSION }}/
          cp scripts/install.ps1 release/${{ steps.version.outputs.VERSION }}/
      
      - name: Generate checksums
        run: |
          cd release/${{ steps.version.outputs.VERSION }}
          sha256sum poketactix-cli-* > SHA256SUMS
          md5sum poketactix-cli-* > MD5SUMS
      
      - name: Create archives
        run: |
          cd release/${{ steps.version.outputs.VERSION }}
          
          # Windows
          zip poketactix-cli-windows-amd64-${{ steps.version.outputs.VERSION }}.zip \
            poketactix-cli-windows-amd64.exe README.md install.ps1 LICENSE || true
          
          # macOS Intel
          tar -czf poketactix-cli-darwin-amd64-${{ steps.version.outputs.VERSION }}.tar.gz \
            poketactix-cli-darwin-amd64 README.md install.sh LICENSE || true
          
          # macOS ARM
          tar -czf poketactix-cli-darwin-arm64-${{ steps.version.outputs.VERSION }}.tar.gz \
            poketactix-cli-darwin-arm64 README.md install.sh LICENSE || true
          
          # Linux AMD64
          tar -czf poketactix-cli-linux-amd64-${{ steps.version.outputs.VERSION }}.tar.gz \
            poketactix-cli-linux-amd64 README.md install.sh LICENSE || true
          
          # Linux ARM64
          tar -czf poketactix-cli-linux-arm64-${{ steps.version.outputs.VERSION }}.tar.gz \
            poketactix-cli-linux-arm64 README.md install.sh LICENSE || true
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/${{ steps.version.outputs.VERSION }}/*.zip
            release/${{ steps.version.outputs.VERSION }}/*.tar.gz
            release/${{ steps.version.outputs.VERSION }}/SHA256SUMS
            release/${{ steps.version.outputs.VERSION }}/MD5SUMS
            release/${{ steps.version.outputs.VERSION }}/poketactix-cli-windows-amd64.exe
            release/${{ steps.version.outputs.VERSION }}/poketactix-cli-darwin-amd64
            release/${{ steps.version.outputs.VERSION }}/poketactix-cli-darwin-arm64
            release/${{ steps.version.outputs.VERSION }}/poketactix-cli-linux-amd64
            release/${{ steps.version.outputs.VERSION }}/poketactix-cli-linux-arm64
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## PokeTacTix CLI ${{ steps.version.outputs.VERSION }}
            
            ### Installation
            
            **Quick Install (macOS/Linux):**
            ```bash
            curl -L https://github.com/${{ github.repository }}/raw/main/scripts/install.sh | bash
            ```
            
            **Quick Install (Windows):**
            ```powershell
            powershell -ExecutionPolicy Bypass -Command "iwr https://github.com/${{ github.repository }}/raw/main/scripts/install.ps1 | iex"
            ```
            
            ### Downloads
            
            Choose the appropriate binary for your platform:
            
            - **Windows (64-bit)**: `poketactix-cli-windows-amd64.exe`
            - **macOS (Intel)**: `poketactix-cli-darwin-amd64`
            - **macOS (Apple Silicon)**: `poketactix-cli-darwin-arm64`
            - **Linux (64-bit)**: `poketactix-cli-linux-amd64`
            - **Linux (ARM64)**: `poketactix-cli-linux-arm64`
            
            ### Verification
            
            Verify your download with the provided `SHA256SUMS` file.
            
            ### Documentation
            
            See [CLI_README.md](https://github.com/${{ github.repository }}/blob/main/CLI_README.md) for complete documentation.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
